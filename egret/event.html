<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>egret事件机制 | FunkyFun</title>
    <meta name="description" content="egret事件机制">
    
    
    <link rel="preload" href="/assets/css/styles.11ed2571.css" as="style"><link rel="preload" href="/assets/js/app.11ed2571.js" as="script"><link rel="preload" href="/assets/js/9.c7315dac.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.9b755c4e.css"><link rel="prefetch" href="/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/assets/js/1.9b755c4e.js"><link rel="prefetch" href="/assets/js/10.f40c243a.js"><link rel="prefetch" href="/assets/js/11.783dce6a.js"><link rel="prefetch" href="/assets/js/12.8675bc87.js"><link rel="prefetch" href="/assets/js/13.b22ee64f.js"><link rel="prefetch" href="/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/assets/js/3.602fac18.js"><link rel="prefetch" href="/assets/js/4.96c12584.js"><link rel="prefetch" href="/assets/js/5.8c87e54c.js"><link rel="prefetch" href="/assets/js/6.b8437547.js"><link rel="prefetch" href="/assets/js/7.d5fa8bac.js"><link rel="prefetch" href="/assets/js/8.e7f9ae54.js">
    <link rel="stylesheet" href="/assets/css/1.styles.9b755c4e.css"><link rel="stylesheet" href="/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/assets/css/styles.11ed2571.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">FunkyFun</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/funkyfun/funkyblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/funkyfun/funkyblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/egret/" class="sidebar-link">开篇</a></li><li><a href="/egret/event.html" class="active sidebar-link">egret事件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egret/event.html#egret事件的实现" class="sidebar-link">egret事件的实现</a></li><li class="sidebar-sub-header"><a href="/egret/event.html#事件机制的注意点" class="sidebar-link">事件机制的注意点</a></li></ul></li><li><a href="/egret/MVC1.html" class="sidebar-link">一个基于egret的MVC架构</a></li><li><a href="/egret/canvasTouch.html" class="sidebar-link">处理Canvas上元素的点击事件</a></li><li><a href="/summary.html" class="sidebar-link">返回分类</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="egret事件机制"><a href="#egret事件机制" aria-hidden="true" class="header-anchor">#</a> egret事件机制</h1> <h2 id="egret事件的实现"><a href="#egret事件的实现" aria-hidden="true" class="header-anchor">#</a> egret事件的实现</h2> <p>从<a href="http://developer.egret.com/cn/apidoc/" target="_blank" rel="noopener noreferrer">Api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档可以看出，所有的类基本都是按照 ...=&gt;<code>egret.EventDispatcher</code> =&gt; <code>egret.HashObject</code>的继承路径。</p> <p>（HashObject是所有egret类的基类，作用是在每个对象初始化的时候给对象加一个hash值，这个hash值是一个全局自增的id值）</p> <p>所有的显示对象都是继承了EventDispatcher，根据这点和命名可以隐约看出这个类是egret事件机制的关键。</p> <p>根据Api暴露的方法可以看出和<a href="https://github.com/primus/eventemitter3" target="_blank" rel="noopener noreferrer">EventEmitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>很像。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">EventDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">HashObject</span> <span class="token keyword">implements</span> <span class="token class-name">IEventDispatcher</span> <span class="token punctuation">{</span>
  <span class="token comment">// public</span>
  <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> priority<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  <span class="token function">once</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> priority<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  <span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  <span class="token function">hasEventListener</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token function">willTrigger</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> Event<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token function">dispatchEventWith</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> bubbles<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> cancelable<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token comment">// private</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>target<span class="token operator">?</span><span class="token punctuation">:</span> IEventDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

  $EventDispatcher<span class="token punctuation">:</span> Object<span class="token punctuation">;</span>

  <span class="token function">$getEventMap</span><span class="token punctuation">(</span>useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

  <span class="token function">$addListener</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> priority<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> dispatchOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
  <span class="token function">$insertEventBin</span><span class="token punctuation">(</span>list<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> useCapture<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> priority<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> dispatchOnce<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  
  <span class="token function">$removeEventBin</span><span class="token punctuation">(</span>list<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> listener<span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> thisObject<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

  <span class="token function">$notifyListener</span><span class="token punctuation">(</span>event<span class="token punctuation">:</span> Event<span class="token punctuation">,</span> capturePhase<span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p>同样和dom的事件监听方式也很像，是一个典型的监听者模式，先注册(addEventListener)对应事件类型（type）的回调，当有事件派发（dispatch）时触发注册的事件回调。</p> <h3 id="construct"><a href="#construct" aria-hidden="true" class="header-anchor">#</a> construct</h3> <p>先从构造函数开始，当<code>new</code>一个显示对象的时候，会调用父类<code>EventDispatcher</code>的构造函数，这时候会在当前显示对象上挂载一个属性名$EventDispatcher的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Keys的枚举代表$EventDispatcher对应的key</span>
<span class="token keyword">const</span> <span class="token keyword">enum</span> Keys<span class="token punctuation">{</span>
    eventTarget<span class="token punctuation">,</span>
    eventsMap<span class="token punctuation">,</span>
    captureEventsMap<span class="token punctuation">,</span>
    notifyLevel
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">EventDispatcher</span> <span class="token keyword">extends</span> <span class="token class-name">HashObject</span> <span class="token keyword">implements</span> <span class="token class-name">IEventDispatcher</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">constructor</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span>IEventDispatcher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$EventDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token number">0</span><span class="token punctuation">:</span> target <span class="token operator">?</span> target <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
      <span class="token number">1</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token number">2</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>eventTarget：显示对象自身的引用</li> <li>eventsMap：当前对象监听的事件列表对象</li> <li>captureEventsMap：同eventsMap，eventsMap包含冒泡阶段的事件列表，captureEventsMap包含捕获阶段的事件列表</li> <li>notifyLevel：处理事件函数的优先级</li></ul> <h3 id="addeventlistener-once"><a href="#addeventlistener-once" aria-hidden="true" class="header-anchor">#</a> addEventListener/once</h3> <p>往显示对象上注册事件监听，这个过程中会在$EventDispatcher属性上的eventsMap和captureEventsMap（取决于useCapture参数）上缓存事件的一些属性。目的是当事件派发时执行相应的回调。
addEventListener和once的区别在于addEventListener注册的事件如果不主动remove的话会一直监听，而once注册的事件在被执行一次后会从监听的事件列表中移除。
同一个显示对象的同一个type的事件的同一个事件的执行者（thisobj）的一个事件回调（listener）在同一个事件阶段（捕获/冒泡）只能监听一次。</p> <h3 id="dispatchevent"><a href="#dispatchevent" aria-hidden="true" class="header-anchor">#</a> dispatchEvent</h3> <p>事件的流向载体是显示列表，也就是egret的parent和child关系。
dispatch的过程其实就是拿到dispatcher上的eventsMap和captureEventsMap（看是冒泡还是捕获阶段）,看里面有没有这个事件的回调，然后执行。
egret.DisplayObject在dispatch的时候会去遍历父节点，然后将父节点一个个按顺序放入数组，然后再拷贝一份倒置顺序，然后合并两个数组，dispatch的时候再去遍历这个数组然后挨个notify，这样就模拟了冒泡和捕获。</p> <h3 id="dispatchevent和dispatcheventwith"><a href="#dispatchevent和dispatcheventwith" aria-hidden="true" class="header-anchor">#</a> dispatchEvent和dispatchEventWith</h3> <p>dispatchEventWith内部调用了Event.create从对象池中获取事件对象，然后调用dispatchEvent，理论上比直接调用dispatchEvent性能要好。</p> <h3 id="evenbus跨组件通信"><a href="#evenbus跨组件通信" aria-hidden="true" class="header-anchor">#</a> evenBus跨组件通信</h3> <p>由于事件是通过显示列表的父子关系来实现冒泡和捕获，有时候我们想在子组件通知父组件做一些操作时，父组件监听一个自定义事件，子组件派发这个事件就行，但兄弟节点就不能实现这种事件通信。
这个时候我们可以创建一个EventBus（new一个EventDispatcher），在a组件中通过EventBus来注册事件回调，然后在b组件通过EventBus派发事件。</p> <h2 id="事件机制的注意点"><a href="#事件机制的注意点" aria-hidden="true" class="header-anchor">#</a> 事件机制的注意点</h2> <ul><li><p>事件类型为字符串类型，容易造成冲突，事件类型尽量集中统一定义，通过业务加不同的前缀，规避和引擎定义的类型冲突。</p></li> <li><p>事件注册的监听函数的执行者（thisobj）可能是其他对象，被引用的对象如果在从显示列表移除且希望被垃圾回收，这个时候还需要remove掉之前挂在其他对象上的事件监听，不然不会被gc。</p></li> <li><p>事件流是基于显示对象的child和parent关系，如果派发的事件希望被监听到，事件的派发者必须是监听者的child或者自己本身。</p></li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/funkyfun/funkyblog/edit/master/docs/egret/event.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/15/2018, 1:39:42 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/egret/" class="prev router-link-active">
          开篇
        </a></span> <span class="next"><a href="/egret/MVC1.html">
          一个基于egret的MVC架构
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/9.c7315dac.js" defer></script><script src="/assets/js/app.11ed2571.js" defer></script>
  </body>
</html>
