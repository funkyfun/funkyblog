<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个基于egret的MVC | FunkyFun</title>
    <meta name="description" content="funkyfun技术博客">
    
    
    <link rel="preload" href="/assets/css/styles.11ed2571.css" as="style"><link rel="preload" href="/assets/js/app.11ed2571.js" as="script"><link rel="preload" href="/assets/js/7.d5fa8bac.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.9b755c4e.css"><link rel="prefetch" href="/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/assets/js/1.9b755c4e.js"><link rel="prefetch" href="/assets/js/10.f40c243a.js"><link rel="prefetch" href="/assets/js/11.783dce6a.js"><link rel="prefetch" href="/assets/js/12.8675bc87.js"><link rel="prefetch" href="/assets/js/13.b22ee64f.js"><link rel="prefetch" href="/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/assets/js/3.602fac18.js"><link rel="prefetch" href="/assets/js/4.96c12584.js"><link rel="prefetch" href="/assets/js/5.8c87e54c.js"><link rel="prefetch" href="/assets/js/6.b8437547.js"><link rel="prefetch" href="/assets/js/8.e7f9ae54.js"><link rel="prefetch" href="/assets/js/9.c7315dac.js">
    <link rel="stylesheet" href="/assets/css/1.styles.9b755c4e.css"><link rel="stylesheet" href="/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/assets/css/styles.11ed2571.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">FunkyFun</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/funkyfun/funkyblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/funkyfun/funkyblog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/egret/" class="sidebar-link">开篇</a></li><li><a href="/egret/event.html" class="sidebar-link">egret事件机制</a></li><li><a href="/egret/MVC1.html" class="active sidebar-link">一个基于egret的MVC架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egret/MVC1.html#解决现阶段问题" class="sidebar-link">解决现阶段问题</a></li><li class="sidebar-sub-header"><a href="/egret/MVC1.html#基本原则" class="sidebar-link">基本原则</a></li><li class="sidebar-sub-header"><a href="/egret/MVC1.html#view层" class="sidebar-link">view层</a></li><li class="sidebar-sub-header"><a href="/egret/MVC1.html#model层" class="sidebar-link">Model层</a></li><li class="sidebar-sub-header"><a href="/egret/MVC1.html#ctrl层" class="sidebar-link">ctrl层</a></li></ul></li><li><a href="/egret/canvasTouch.html" class="sidebar-link">处理Canvas上元素的点击事件</a></li><li><a href="/summary.html" class="sidebar-link">返回分类</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="一个基于egret的mvc"><a href="#一个基于egret的mvc" aria-hidden="true" class="header-anchor">#</a> 一个基于egret的MVC</h1> <h2 id="解决现阶段问题"><a href="#解决现阶段问题" aria-hidden="true" class="header-anchor">#</a> 解决现阶段问题</h2> <ul><li>获取组件实例困难，跨组件交互和通信复杂</li> <li>业务逻辑糅杂在一起，维护火葬场</li> <li>bug难定位</li></ul> <h2 id="基本原则"><a href="#基本原则" aria-hidden="true" class="header-anchor">#</a> 基本原则</h2> <p>view<code>只</code>负责视图更新，model<code>只</code>负责存储数据和格式化后端数据，ctrl<code>只</code>控制业务逻辑</p> <h2 id="view层"><a href="#view层" aria-hidden="true" class="header-anchor">#</a> view层</h2> <p>基于eui.Component封装了一个BaseComponent，提供了几个简单的生命周期函数，<code>onCreating</code> <code>onCreated</code> <code>onShow</code> <code>onHide</code>，在继承这个类的子类里重写这些方法，会在每个生命周期时回调这个函数。</p> <ul><li><code>onCreating</code> eui组件的构建中，皮肤中定义了id的组件构造完成时会走这个方法，这个方法提供两个参数子组件的id，子组件实例，可以在这个方法里对子组件进行额外的初始化操作，比如监听事件</li> <li><code>onCreated</code> 组件构建完成，组件的构造是个异步过程</li> <li><code>onShow</code> 被添加到舞台时的回调，省去每次重复写大段的监听代码</li> <li><code>beforeHide</code> 被移除舞台，是个asyn函数</li> <li><code>ondestroyed</code>（待完成） 被销毁，暂时没有想到好的实现</li></ul> <p>还封装了一个通用fillContainer工具方法，用来填充父容器</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">BaseComponent</span> <span class="token keyword">extends</span> <span class="token class-name">eui<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token function">initHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>egret<span class="token punctuation">.</span>Event<span class="token punctuation">.</span><span class="token constant">ADDED_TO_STAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onShow<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>egret<span class="token punctuation">.</span>Event<span class="token punctuation">.</span><span class="token constant">REMOVED_FROM_STAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onHide<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// this.addEventListener('COMPONENT_DESTROYED', this.onDestroyed, this);</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token function">childrenCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">childrenCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token function">partAdded</span><span class="token punctuation">(</span>partName<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> instance<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">partAdded</span><span class="token punctuation">(</span>partName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCreating</span><span class="token punctuation">(</span>partName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 组件初始化时 部件被添加时调用，子类覆盖
     * 用于添加部件事件监听 设置属性
     */</span>
    <span class="token keyword">protected</span> <span class="token function">onCreating</span><span class="token punctuation">(</span>partName<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> instance<span class="token punctuation">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 组件初始化完成 被添加至舞台时调用，子类覆盖
     */</span>
    <span class="token keyword">protected</span> <span class="token function">onCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token function">onShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 从父组件移除前执行
     * 
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">async</span> <span class="token function">beforeHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token function">onHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token function">onDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>

    <span class="token function">onUpdated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 从父组件移除
     * 
     */</span>
    <span class="token keyword">async</span> <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beforeHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Tools<span class="token punctuation">.</span><span class="token function">removeFromParent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 重新设置组件的宽高，使之与容器保持一致
     * @param compoment
     * @param container
     * 
     */</span>
    <span class="token function">fillContainer</span><span class="token punctuation">(</span>compoment<span class="token punctuation">:</span> egret<span class="token punctuation">.</span>DisplayObject<span class="token punctuation">,</span> container<span class="token punctuation">:</span> egret<span class="token punctuation">.</span>DisplayObjectContainer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> container <span class="token operator">=</span> compoment<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>width<span class="token punctuation">,</span> height<span class="token punctuation">}</span> <span class="token operator">=</span> container<span class="token punctuation">;</span>
            Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>compoment<span class="token punctuation">,</span> <span class="token punctuation">{</span>width<span class="token punctuation">,</span> height<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            egret<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`传入容器不为空或</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>compoment<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">必须先加入父容器`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个view的栗子，view只负责初始化，提供修改视图的方法，具体业务逻辑不出现在view内：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ChildView</span> <span class="token keyword">extends</span> <span class="token class-name">XhGame<span class="token punctuation">.</span>BaseComponent</span><span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'ChildViewName'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>skinName <span class="token operator">=</span> <span class="token string">&quot;ChildViewSkin&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onCreating</span><span class="token punctuation">(</span>partName<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> instance<span class="token punctuation">:</span> egret<span class="token punctuation">.</span>DisplayObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>partName<span class="token punctuation">]</span> <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>partName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'btnClose'</span><span class="token punctuation">:</span>
                instance<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>egret<span class="token punctuation">.</span>TouchEvent<span class="token punctuation">.</span><span class="token constant">TOUCH_TAP</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hide<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'item1'</span><span class="token punctuation">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initItem1</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>eui<span class="token punctuation">.</span>Group<span class="token operator">&gt;</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'item2'</span><span class="token punctuation">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initItem2</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>eui<span class="token punctuation">.</span>Group<span class="token operator">&gt;</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">onCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建后 只回调一次</span>
    <span class="token punctuation">}</span>
    <span class="token function">onShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillContainer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">onHide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dosomething onHide</span>
    <span class="token punctuation">}</span>

    <span class="token function">initItem1</span><span class="token punctuation">(</span>tabview<span class="token punctuation">:</span> eui<span class="token punctuation">.</span>Group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dosomething init item1</span>
        <span class="token comment">// this.item1.addEventListener()</span>
    <span class="token punctuation">}</span>
    <span class="token function">initItem2</span><span class="token punctuation">(</span>tabview<span class="token punctuation">:</span> eui<span class="token punctuation">.</span>Group<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dosomething init item2</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 提供方法给ctrl设置更新视图
     * */</span>
    <span class="token function">updateItem1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// dosomething set item1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> item1<span class="token punctuation">:</span>eui<span class="token punctuation">.</span>Group<span class="token punctuation">;</span>
    <span class="token keyword">public</span> item2<span class="token punctuation">:</span>eui<span class="token punctuation">.</span>Group<span class="token punctuation">;</span>
    <span class="token keyword">public</span> item3<span class="token punctuation">:</span>eui<span class="token punctuation">.</span>Group<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> btnClose<span class="token punctuation">:</span>eui<span class="token punctuation">.</span>Group<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="model层"><a href="#model层" aria-hidden="true" class="header-anchor">#</a> Model层</h2> <p>数据仓库</p> <ul><li>构造时添加默认值，这样的好处是后台没有的时候自己可以mock一些数据，ctrl在调用的时候保证有值不至于报错。</li> <li>提供数据格式化方法，在拿到后台数据时不一定是我们想要的格式，处理后台数据</li> <li>根据复杂情况，使用属性的getter和setter</li> <li>Model只负责提供格式化的数据，后台的数据格式化工作在这里处理</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ChildViewModel</span><span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 默认值赋值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>countdown <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_checkinInfoArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_prizeinfoArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    proto1<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    proto2<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    <span class="token comment">// ...more proto</span>
    <span class="token function">proto1DataFormat</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 格式化data</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ctrl层"><a href="#ctrl层" aria-hidden="true" class="header-anchor">#</a> ctrl层</h2> <p>控制器业务层</p> <ul><li>单例, 业务之间调用ctrl而不view或者model</li> <li>控制器同时包含view的实例和model的实例，在控制器内处理业务逻辑代码会更清晰</li> <li>由视图触发的逻辑可以通过事件抛到ctrl来处理，比如点击，视图只处理视图的显示逻辑</li> <li>ctrl负责与后台交互数据,处理业务逻辑，交给model格式化数据和更新model，然后调用对应view更新的方法，view更新视图</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">ChildViewCtrl</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> _instance<span class="token punctuation">:</span> ChildViewCtrl<span class="token punctuation">;</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ChildViewCtrl<span class="token punctuation">.</span>_instance<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token template-string"><span class="token string">`ChildViewCtrl cannot use new operator`</span></span><span class="token punctuation">;</span>
        ChildViewCtrl<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ChildViewCtrl<span class="token punctuation">.</span>_instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">ChildViewCtrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ChildViewCtrl<span class="token punctuation">.</span>_instance<span class="token punctuation">.</span>model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ChildViewCtrl<span class="token punctuation">.</span>_instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// view</span>
    view<span class="token punctuation">:</span> ChildView<span class="token punctuation">;</span>
    <span class="token comment">// more view ...</span>

    <span class="token comment">// model</span>
    model<span class="token punctuation">:</span> ChildViewModel<span class="token punctuation">;</span>
    <span class="token comment">// more model ...</span>

    <span class="token comment">// Event</span>
    <span class="token comment">/** 事件B */</span>
    <span class="token keyword">static</span> <span class="token constant">EVENT_A</span> <span class="token operator">=</span> <span class="token string">&quot;EVENT_A&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/** 事件A */</span>
    <span class="token keyword">static</span> <span class="token constant">EVENT_B</span> <span class="token operator">=</span> <span class="token string">&quot;EVENT_B&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/** 主界面 */</span>
    <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span>container<span class="token punctuation">:</span> egret<span class="token punctuation">.</span>DisplayObjectContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// load res</span>
            <span class="token keyword">await</span> <span class="token constant">RES</span><span class="token punctuation">.</span><span class="token function">getResAsync</span><span class="token punctuation">(</span><span class="token string">'XXX_json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChildView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// addEventListener</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>BzPrizeCenterCtrl<span class="token punctuation">.</span><span class="token constant">EVENT_A</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onEventA<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>BzPrizeCenterCtrl<span class="token punctuation">.</span><span class="token constant">EVENT_B</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onEventB<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新model</span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新view</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setViewInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加到父容器</span>
        container<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/** 拉后台数据 */</span>
    <span class="token keyword">async</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> promise1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadInitData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadInitData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>promise1<span class="token punctuation">,</span> promise2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">loadInitData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> Service<span class="token punctuation">.</span><span class="token function">getData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用model的格式化方法格式化数据，同时更新model</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">initDateFormat1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">loadInitData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> Service<span class="token punctuation">.</span><span class="token function">getData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用model的格式化方法格式化数据，同时更新model</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">initDateFormat2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/** 更新view */</span>
    <span class="token function">setViewInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span>proto<span class="token punctuation">;</span>
      <span class="token comment">// 业务逻辑</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">updateItem1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/funkyfun/funkyblog/edit/master/docs/egret/MVC1.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/14/2018, 1:01:10 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/egret/event.html" class="prev">
          egret事件机制
        </a></span> <span class="next"><a href="/egret/canvasTouch.html">
          处理Canvas上元素的点击事件
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/7.d5fa8bac.js" defer></script><script src="/assets/js/app.11ed2571.js" defer></script>
  </body>
</html>
